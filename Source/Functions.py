
#==========================================================================================#
# >>>>> –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö –ò –ú–û–î–£–õ–ï–ô <<<<< #
#==========================================================================================#

from dublib.Methods import RemoveFolderContent, ReadJSON


import datetime
import logging
import telebot
import shutil
import os
        
#==========================================================================================#
# >>>>> –û–¢–ü–†–ê–í–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò <<<<< #
#==========================================================================================#

def GenerateStatistics(Bot: telebot.TeleBot, UserID: str, ChatID: int, SizeObject: any, FlowObject):
    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
    MessageText = "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞* \n\n"

    # –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    Files = os.listdir("Data/Files/" + str(UserID))
    
    # –†–∞–∑–º–µ—Ä –≤—Å–µ—Ö —Å–∫–∞—á–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
    Size = SizeObject.GetSizeDirectory(Files, str(UserID))

    # –°–ª–æ–≤–∞—Ä—å —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤.
    FileTypes = {
        "photo": 0,
        "video": 0,
        "document": 0,
        "audio": 0
    }

    # –°–ª–æ–≤–∞—Ä—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤.
    FileExtensions = {
        "photo": ["jpg", "png", "webp", "jpeg", "ico", "gif", "svg"],
        "video": ["mp4", "avi", "wmw", "mkv", "3gp", "flv", "mov", "mpeg"],
        "audio": ["mp3", "ogg", "wav", "wma"]
    }
    
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞.
    for File in Files:
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ: –±—ã–ª –ª–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª.
        IsTyped = False

        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.
        for ExtensionType in FileExtensions.keys():
            # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞.
            FileExtension = File.split('.')[-1]
            
            # –ï—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–∞–∫–æ–º—É-—Ç–æ —Ç–∏–ø—É.
            if FileExtension in FileExtensions[ExtensionType]:
                # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ —Ç–∏–ø–∞.
                FileTypes[ExtensionType] +=1
                # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏.
                IsTyped = True

        # –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, —Ç–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
        if IsTyped == False:
            FileTypes["document"] +=1

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    MessageText += "‚è≥ *–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤*\: " + str(FlowObject.CountMessagesBufer()) + "\n" + "\n"

    try:
        MessageText += "üì¶ *–¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞*\: " + str(SizeObject.Converter("Any", Size)).replace('.','\.') + "\n" + "\n"
    except:
        MessageText += "üì¶ *–¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞*\: " + "0B" + "\n" + "\n"

    MessageText += "üóÑ *_–¢–∏–ø—ã —Ñ–∞–π–ª–æ–≤_*\: " + "\n" + "\n"

    MessageText += "üì∑ _–§–æ—Ç–æ_\: " + str(FileTypes["photo"]) + "\n"
    MessageText += "üìΩ _–í–∏–¥–µ–æ_\: " + str(FileTypes["video"]) + "\n"
    MessageText += "üíº _–î–æ–∫—É–º–µ–Ω—Ç—ã_\: " + str(FileTypes["document"]) + "\n"
    MessageText += "üéµ _–ê—É–¥–∏–æ_\: " + str(FileTypes["audio"]) + "\n" + "\n"

    MessageText += "‚ùå *_–û—à–∏–±–∫–∏_*\: "  + str(len(ReadJSON("Data/Users/" + UserID + ".json")["UnloadedFiles"]))
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    Bot.send_message(ChatID, MessageText, parse_mode = "MarkdownV2")

#==========================================================================================#
# >>>>> –û–¢–ü–†–ê–í–ö–ê –ê–†–•–ò–í–ê  <<<<< #
#==========================================================================================#

def SendArchive(Bot: telebot.TeleBot, UserID: str, ChatID: int, UserDataObject: any):

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã.
    Date = datetime.datetime.now()

    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞.
    Date = str(Date).replace(':', '-').split('.')[0]
    
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ: —É–¥–∞–ª–∞—Å—å –ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞.
    IsSended = False

    # –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.
    while len(os.listdir("Data/Files/" + UserID)) > 0:

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        Bot.send_message(ChatID, "‚è≥ –°–±–æ—Ä–∫–∞\n\n –ò–¥—ë—Ç —É–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞...")

        # –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        shutil.make_archive(f"Data/Archives/{UserID}/{Date}", "zip", "Data/Files/" + UserID)

        # –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
        RemoveFolderContent("Data/Files/" + UserID)

        # –ë–∏–Ω–∞—Ä–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞.
        BinaryArchive = None

        # –ß—Ç–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞.
        with open(f"Data/Archives/{UserID}/{Date}.zip", "rb") as FileReader:
            BinaryArchive = FileReader.read()
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        Bot.send_document(ChatID, BinaryArchive, visible_file_name = f"{Date}.zip")

        # –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
        logging.info("–ê—Ä—Ö–∏–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")

        try: 
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π –Ω–µ–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
            UnloadedFiles = UserDataObject.GetInfo(UserID, "UnloadedFiles")
            # print(UnloadedFiles[0])

            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.
            Bot.send_message(ChatID,"‚è≥ –°–±–æ—Ä–∫–∞\n\n –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –Ω–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã..." )
            
            for Sequence in range(len(UnloadedFiles)):
                
                if UnloadedFiles[0]["type"] == "document": 
                    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å.
                    Bot.send_document(ChatID, document = UnloadedFiles[0]["file"])
                    del UnloadedFiles[0]
  
                if UnloadedFiles[0]["type"] == "audio":  
                    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å.
                    Bot.send_audio(ChatID, audio = UnloadedFiles[0]["file"])
                    del UnloadedFiles[0]

                if UnloadedFiles[0]["type"] == "video": 
                    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å.
                    Bot.send_video(ChatID, video = UnloadedFiles[0]["file"])
                    del UnloadedFiles[0] 

                if UnloadedFiles[0]["type"] == "photo": 
                    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å.
                    Bot.send_photo(ChatID, photo = UnloadedFiles[0]["file"])
                    del UnloadedFiles[0]
             
        except:
            # –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
            logging.info("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")
       
        # –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
        RemoveFolderContent("Data/Archives/" + UserID)
        
        # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
        IsSended = True

    return IsSended



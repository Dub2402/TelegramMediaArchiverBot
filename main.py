#!/usr/bin/python

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º telebot –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç–µ–ª–µ–≥—Ä–∞–º–º - –±–æ—Ç–∞.
import telebot
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º types –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ telebot –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫.
from telebot import types
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º requests –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
import requests
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º os –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ñ–æ—Ç–æ.
import os
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º fnmatch –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞.
import fnmatch
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º shutil –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤.
import shutil

from dublib.Methods import CheckPythonMinimalVersion, MakeRootDirectories, ReadJSON

#==========================================================================================#
# >>>>> –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ö–†–ò–ü–¢–ê <<<<< #
#==========================================================================================#

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –≤–µ—Ä—Å–∏–∏ Python.
CheckPythonMinimalVersion(3, 10)
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
MakeRootDirectories(["Uploads"])

#==========================================================================================#
# >>>>> –ß–¢–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö <<<<< #
#==========================================================================================#

# –ß—Ç–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
Settings = ReadJSON("Settings.json")

# –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω, –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
if type(Settings["token"]) != str or Settings["token"].strip() == "":
    raise Exception("Invalid Telegram bot token.")

#==========================================================================================#
# >>>>> –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê –ò –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î <<<<< #
#==========================================================================================#

# –¢–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ —Ç–µ–ª–µ–≥–∞–º–º.
bot = telebot.TeleBot(Settings["token"])

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π images - –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
images = 0
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π videos - –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –≤–∏–¥–µ–æ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
videos = 0

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã start.
@bot.message_handler(commands=['start'])
# –§—É–Ω–∫—Ü–∏—è, –≤—ã–≤–æ–¥—è—â–∞—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.
def start(message):
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π markup.
    global markup
    # –°–æ–∑–¥–∞–Ω–∏–µ ReplyKeyboardMarkup –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True).add(
        types.KeyboardButton('üì¶ –ù–∞—á–∞—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏'))
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç–æ–º –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–æ—á–µ–∫.
    bot.send_message(message.chat.id, 
                     '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø - –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±–ª–µ–≥—á–∏—Ç –≤–∞–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π.\n–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É: üì¶ –ù–∞—á–∞—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏.',
                       reply_markup = markup)
    

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ (–≤ –±—É–¥—É—â–µ–º –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ: 'document', 'audio').
@bot.message_handler(content_types=['photo', 'video'])
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ.
def bot_message(message):
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π images.
    global images
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π videos.
    global videos
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤.
    bot.send_message(message.chat.id, '–ò–¥–µ—Ç —Å–±–æ—Ä–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏')
    # –ï—Å–ª–∏ —Ç–∏–ø –ø–æ–ª—É—á–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:
    if message.content_type == 'photo':
        # –ü–æ–ª—É—á–µ–Ω–∏–µ id –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
        photo_id = message.photo[-1].file_id 
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.
        file_info = bot.get_file(photo_id) 
        # –û—Ç–ø—Ä–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ.
        file = requests.get(f'https://api.telegram.org/file/bot{Settings["token"]}/{file_info.file_path}') 
        # –î–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º.
        file_name = 'photo' + message.photo[-1].file_id + '.jpg' 
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.
        with open(f'Uploads/{file_name}', 'wb') as f:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
            f.write(file.content)
            # –û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å—á–µ—Ç–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
            images +=1
    else:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ id –≤–∏–¥–µ–æ.
        video_id = message.video.file_id 
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.
        file_info = bot.get_file(video_id) 
        # –û—Ç–ø—Ä–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ.
        file = requests.get(f'https://api.telegram.org/file/bot{Settings["token"]}/{file_info.file_path}') 
        # –î–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º.
        file_name = 'video' + message.video.file_id + '.mp4' 
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.
        with open(f'Uploads/{file_name}', 'wb') as f:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
            f.write(file.content)
            # –û—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å—á–µ—Ç–∞ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤.
            videos +=1
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_files.
    global number_files
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_videos.
    global number_videos
    # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_images.
    global number_images
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–∞–ø–∫–µ.
    number_files = len(os.listdir('Uploads'))
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .jpg –≤ –ø–∞–ø–∫–µ.
    number_images = len(fnmatch.filter(os.listdir('Uploads/'),'*.jpg'))
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .mp4 –≤ –ø–∞–ø–∫–µ.
    number_videos = len(fnmatch.filter(os.listdir('Uploads/'),'*.mp4'))
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤.
    bot.send_message(message.chat.id, f'–î–æ–±–∞–≤–ª–µ–Ω–æ {images} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ {videos} –≤–∏–¥–µ–æ.')
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é.
    bot.send_message(message.chat.id, f'–í –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–æ–±–∞–≤–ª–µ–Ω–æ {number_files} –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤. –ò–∑ –Ω–∏—Ö {number_images} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ {number_videos} –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤.')


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞.
@bot.message_handler(content_types=['text'])
# –§—É–Ω–∫—Ü–∏—è, –≤—ã–≤–æ–¥—è—â–∞—è –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ–∫—Å—Ç.
def bot_message(message):
    # –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–∞ —Ç–µ–∫—Å—Ç 'üì¶ –ù–∞—á–∞—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏':
    if message.text == 'üì¶ –ù–∞—á–∞—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏':
        # –í—ã–≤–æ–¥ –∫–Ω–æ–ø–∫–∏ ‚õîÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
        markup1 = types.ReplyKeyboardMarkup(resize_keyboard=True).add(types.KeyboardButton('‚õîÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏'))
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏(‚õîÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏).
        bot.send_message(message.chat.id, '–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏. –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞.', reply_markup=markup1)
    else:
        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π markup.
        global markup
        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_files.
        global number_files
        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_videos.
        global number_videos
        # –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π number_images.
        global number_images
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏(üì¶ –ù–∞—á–∞—Ç—å —Å–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏).
        bot.send_message(message.chat.id, f'–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –æ–∫–æ–Ω—á–µ–Ω–æ. –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è {number_files} —Ñ–∞–π–ª–æ–≤. –ò–∑ –Ω–∏—Ö {number_images} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ {number_videos} –≤–∏–¥–µ–æ.', reply_markup=markup)
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ –∞—Ä—Ö–∏–≤.
        shutil.make_archive('archive', 'zip', 'Uploads' )
   

# –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—Ç—ã –∫–æ–¥–∞.
if __name__ == "__main__":
    # –û–ø—Ä–æ—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
    bot.polling(none_stop=True)